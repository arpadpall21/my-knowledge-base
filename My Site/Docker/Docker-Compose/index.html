<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title> Docker-Compose </title>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" href="../../Assets/stylesPages.css">
    <script src="../../Assets/scriptPages.js"></script>
  </head>

  <body>
    <h1> Docker-Compose </h1>
    <p> Updated: ( 2022-01-24 / 2025-03-19 )</p>
    <nav class="sitenav"> <a href="../../index.html" title="home">MySite > </a>
      <a href="../index.html">Docker > </a> Docker-Compose
    </nav>
    <table class="table">
      <tr>
        <th style="width:30%;"> Instruction </th>
        <th> Description </th>
      </tr>
      <tr>
        <td>
          <em>docker-compose</em> <strong>args</strong>
        </td>
        <td>
          - docker-compose (V1) <br>
          - binary, has to be installed explicitly
        </td>
      </tr>
      <tr>
        <td>
          <em>docker compose</em> <strong>args</strong>
        </td>
        <td>
          - docker-compose (V2) <br>
          - part of the docker daemon, fully compatible with <mark>docker-compose</mark> (v1) binary
        </td>
      </tr>
      <tr>
        <td>|</td>
        <td></td>
      </tr>
      <tr>
        <td colspan="2">
          Commands
        </td>
      </tr>
      <tr>
        <td>
          <em>docker-compose</em> <small>[-f <i>composeFile</i>]</small> <small>[--profile <i>profile</i>]</small> up <small>[-d]</small> <i>srv ...</i>
        </td>
        <td>
          - starts (ups) all services in the default (<mark class="mark">docker-compose.yml</mark>) project <br>
          - (<small>-f <i>composeFile</i></small>) custom project instead of the default (can be multiple) (multiple can be passed = will merge service configs) <br>
          - (<small>--profile <i>profile</i></small>) enables services having the <i>profile</i> profile <br>
          - (<small>-d</small>) runs services in 'detached' mode <br>
          - <i>srv ...</i> the specified service(es) only
        </td>
      </tr>
      <tr>
        <td>
          <em>docker-compose</em> <small>[-f <i>composeFile</i>]</small> down <small>[--rmi all]</small> <small>[-v]</small>
        </td>
        <td>
          - stops (downs) all services in the default (<mark class="mark">docker-compose.yml</mark>) project <br>
          - (<small>-f <i>composeFile</i></small>) custom project instead of the default (can be multiple) <br>
          - (<small>--rmi all</small>) also removes images of this project <br>
          - (<small>-v</small>) also removes volumes of this project
        </td>
      </tr>
      <tr>
        <td>
          <em>docker-compose</em> <small>[-f <i>composeFile</i>]</small> build <small>[--build-arg <i>key</i>=<i>val</i>]</small> <i>srv ...</i>
        </td>
        <td>
          - rebuilds all containers in the default (<mark class="mark">docker-compose.yml</mark>) project (restart the project for the changes to take effect) <br>
          - (<small>-f <i>composeFile</i></small>) custom project instead of the default (can be multiple) <br>
          - (<small>--build-arg <i>val</i>=<i>key</i></small>) passes build time arguments (for the <mark class="mark">Dockerfile</mark> <mark class="mark">ARG</mark> instruction) <br>
          - <i>srv ...</i> for the specified service(es) only
        </td>
      </tr>
      <tr>
        <td>
          <em>docker-compose</em> <small>[-f <i>composeFile</i>]</small> pull
        </td>
        <td>
          - pulls docker images in the default (<mark class="mark">docker-compose.yml</mark>) project <br>
          - (<small>-f <i>composeFile</i></small>) custom project instead of the default (can be multiple) <br>
          - <i>srv ...</i> for the specified service(es) only
        </td>
      </tr>
      <tr>
        <td>|</td>
        <td></td>
      </tr>
      <tr>
        <td>
          <em>docker-compose</em> <small>[-f <i>composeFile</i>]</small> ps <i>srv ...</i>
        </td>
        <td>
          - prints all containers in the default (<mark class="mark">docker-compose.yml</mark>) project <br>
          - (<small>-f <i>composeFile</i></small>) custom project instead of the default (can be multiple) <br>
          - <i>srv ...</i> for the specified service(es) only
        </td>
      </tr>
      <tr>
        <td>
          <em>docker-compose</em> <small>[-f <i>composeFile</i>]</small> images <i>srv ...</i>
        </td>
        <td>
          - prints all images in the default (<mark class="mark">docker-compose.yml</mark>) project <br>
          - (<small>-f <i>composeFile</i></small>) custom project instead of the default (can be multiple) <br>
          - <i>srv ...</i> for the specified service(es) only
        </td>
      </tr>
      <tr>
        <td>
          <em>docker-compose</em> <small>[-f <i>composeFile</i>]</small> logs <i>srv ...</i>
        </td>
        <td>
          - prints the logs for the default (<mark class="mark">docker-compose.yml</mark>) project <br>
          - (<small>-f <i>composeFile</i></small>) custom project instead of the default (can be multiple) <br>
          - <i>srv ...</i> for the specified service(es) only
        </td>
      </tr>
      <tr>
        <td>
          <em>docker-compose</em> <small>[-f <i>composeFile</i>]</small> top <i>srv ...</i>
        </td>
        <td>
          - prints all processes within each service in the default (<mark class="mark">docker-compose.yml</mark>) project <br>
          - (<small>-f <i>composeFile</i></small>) custom project instead of the default (can be multiple) <br>
          - <i>srv ...</i> for the specified service(es) only
        </td>
      </tr>
      <tr>
        <td>|</td>
        <td></td>
      </tr>
      <tr>
        <td>
          <em>docker-compose</em> <small>[-f <i>composeFile</i>]</small> start <i>srv ...</i>
        </td>
        <td>
          - starts stopped services in the default (<mark class="mark">docker-compose.yml</mark>) project <br>
          - (<small>-f <i>composeFile</i></small>) custom project instead of the default (can be multiple) <br>
          - <i>srv ...</i> the specified service(es) only
        </td>
      </tr>
      <tr>
        <td>
          <em>docker-compose</em> <small>[-f <i>composeFile</i>]</small> stop <i>srv ...</i>
        </td>
        <td>
          - stops all services in the default (<mark class="mark">docker-compose.yml</mark>) project <u>(does not remove stopped containers)</u><br>
          - (<small>-f <i>composeFile</i></small>) custom project instead of the default (can be multiple) <br>
          - <i>srv ...</i> the specified service(es) only
        </td>
      </tr>
      <tr>
        <td>
          <em>docker-compose</em> <small>[-f <i>composeFile</i>]</small> restart <i>srv ...</i>
        </td>
        <td>
          - restarts running or starts stopped services in the default (<mark class="mark">docker-compose.yml</mark>) project <u>(changes in the project file won't take effect after this command)</u><br>
          - (<small>-f <i>composeFile</i></small>) custom project instead of the default (can be multiple) <br>
          - <i>srv ...</i> the specified service(es) only
        </td>
      </tr>
      <tr>
        <td>|</td>
        <td></td>
      </tr>
      <tr>
        <td>
          <em>docker-compose</em> <small>[-f <i>composeFile</i>]</small> pause <i>srv ...</i>
        </td>
        <td>
          - pauses all services in the default (<mark class="mark">docker-compose.yml</mark>) project <u>(<mark>docker-compose start</mark> cannot unpuase paused services, <mark>docker-compose unpuase</mark> can)</u> <br>
          - (<small>-f <i>composeFile</i></small>) custom project instead of the default (can be multiple) <br>
          - <i>srv ...</i> for the specified service(es) only
        </td>
      </tr>
      <tr>
        <td>
          <em>docker-compose</em> <small>[-f <i>composeFile</i>]</small> unpause <i>srv ...</i>
        </td>
        <td>
          - unpauses all services in the default (<mark class="mark">docker-compose.yml</mark>) project <u>(<mark>docker-compose start</mark> cannot unpuase paused services, this command can)</u> <br>
          - (<small>-f <i>composeFile</i></small>) custom project instead of the default (can be multiple) <br>
          - <i>srv ...</i> for the specified service(es) only
        </td>
      </tr>
    </table>
    <details class="example" id="notes">
      <summary> Notes :</summary>
      <!-- <p> - paragraph removes the 'empty' message from the detail TAG -->
    </details>
    <h2 class="headerSection"> Useful Links : </h2>
    <p><a href="https://docs.docker.com/compose/" target="_blanc">docker compose (docs.docker.com) </a></p>
    <p><a href="https://docs.docker.com/compose/reference/" target="_blanc">docker-compose CLI reference (docs.docker.com) </a></p>
    <p><a href="https://docs.docker.com/reference/compose-file/" target="_blanc">docker-compose file reference (docs.docker.com) </a></p>
    <h2 class="headerSection"> Remember This : </h2>

    <h2 class="headerSection"> Description and Demonstration : </h2>
    <p> - Docker-Compose is a tool to build multi container applications in a centralized way described in a <mark class="mark">docker-compose.yml</mark> file (by default) </p>
    <p> - By default the project name is the basename of the project directory, but it can be changed by the <mark>(run) -p</mark> flag or by the <mark>COMPOSE_PROJECT_NAME</mark> environment variable </p>
    <p> - the project name is used as first segment in the image names, container names and the network name (by default) </p>
    <h4 class="header"> On start (build) (<mark>up</mark>) </h4>
    <p class="indent-lv1"> - all necessary images will be downloaded a built </p>
    <p class="indent-lv1"> - (by default) an isolated bridge network is created and all containers part of the current project are connected on it </p>
    <h4 class="header"> On stop (<mark>down</mark>) </h4>
    <p class="indent-lv1"> - all containers are stopped and removed (that was created by <mark class="mark">up</mark>), removed containers are <u>preserved (but not visible), so on new startup they won't be rebuilt even if we make any changes in their Dockerfile</u></p>
    <p class="indent-lv1"> - the bridge network is removed (that was created by <mark class="mark">up</mark>) </p>
    <p class="indent-lv1"> - (by default) does not remove images (that was created by <mark class="mark">up</mark>) </p>
    <p class="indent-lv1"> - (by default) does not remove volumes (named or anonymus), they are preserved for the next startup (that was created by <mark class="mark">up</mark>) </p>

    <h4 class="header"> Changing the something in the project </h4>
    <p class="indent-lv1"> - if we change something in the compose file, we simply down then up the project <u>changes will take effect</u> </p>
    <p class="indent-lv1"> - if we change something in container level (Dockerfile) we have to rebuild the container with the <mark>docker-compose build <strong>service</strong></mark> command </p>
    <pre class="syntax">
    $ docker-compose -f test1.yml up -d                                                // app systems describe in <mark class="mark">*.yml</mark> files never conflict with each other (have their own network, volumes)
    $ docker-compose -f test2.yml up -d 
    
    $ docker-compose -f test2.yml down                                                 // only the containers and network describe by <mark class="mark">test2.yml</mark> is removed here (no conflict between app systems)
    </pre>
    <details class="example">
      <summary> DEMO </summary>
      <pre class="cmd">
// up / down --------------------------------------------------------------------------
    $ docker-compose up -d                                                             // start services described in the <mark class="mark">docker-compose.yml</mark> file 
    $ docker-compose down                                                              // stops services described in the <mark class="mark">docker-compose.yml</mark> file 
    
  // -----------------------------------------------------
    $ docker-compose -f test.yml -f test2.yml up -d                                    // start services described in the <mark class="mark">test.yml</mark> <mark class="mark">test2.yml</mark> files (merges service configs, where there's conflict the rightmost compose file takes precedence)     
    $ docker-compose -f test.yml -f test2.yml down --rmi all -v                        // stops services but also removes associated images and volumes    
    
    
// using project name -----------------------------------------------------------------
    $ docker-compose --profile myProfile up -d                                         // starts the project with <mark class="mark">myProfile</mark> project name    
    
    
// build ------------------------------------------------------------------------------
    $ docker-compose build                                                             // rebuilds the all containers associated with the default project   
    $ docker-compose build web1                                                        // onlry rebuilds the <mark class="mark">web1</mark> service container    
    
    $ docker-compose up -d                                                             // restart the project in order for the changes to take effect    
    
    $ docker-compose build --build-arg CONTENT=new web1                                // passes a build-time argument for the <mark class="mark">web1</mark> service (Dockerfile <mark>ARG</mark>)
    
    
// ps / images / logs / top ------------------------------------------------------------
    $ docker-compose ps                                                                // prints containers of the default project   
      Name                 Command               State   Ports
      ----------------------------------------------------------
      testcont    docker-entrypoint.sh /bin/ ...   Up           
      testcont2   docker-entrypoint.sh /bin/ ...   Up
    
    
    $ docker-compose images                                                            // prints images used by the default project 
      Container   Repository    Tag       Image Id       Size  
      ---------------------------------------------------------
      testcont    t1_web1      latest   d011feb4f98c   992.5 MB
      testcont2   t1_web2      latest   0771c74b22da   992.5 MB
    
    $ docker-compose -f test.yml images                                                // prints images used by the <mark class="mark">test.yml</mark> project   
      // ...
    
    
    $ docker-compose logs                                                              // prints the logs about the default project  
      Attaching to testcont2, testcont
      testcont2 | server is listening
      testcont2 | server is listening
      testcont | server process 9 is listening
      testcont | server process 9 is listening
      
    $ docker-compose -f test.yml logs                                                  // prints the logs about the <mark class="mark">test.yml</mark> project   
    
    
    $ docker-compose top                                                               // displays running processes for each service  
      testcont
      UID     PID    PPID    C   STIME   TTY     TIME               CMD          
      ---------------------------------------------------------------------------
      root   48433   48414   0   19:47   ?     00:00:00   /bin/sh -c node testSrv
      root   48564   48433   0   19:47   ?     00:00:00   node testSrv           
    
      testcont2
      UID     PID    PPID    C   STIME   TTY     TIME               CMD           
      ----------------------------------------------------------------------------
      root   48481   48456   0   19:47   ?     00:00:00   /bin/sh -c node testSrv2
      root   48594   48481   0   19:47   ?     00:00:00   node testSrv2           
    
    
// pause / unpause --------------------------------------------------------------------
    $ docker-compose -f test.yml pause web3                                            // pauses the <mark class="mark">web3</mark> service in the <mark class="mark">test.yml</mark> project 
    
    $ docker-compose -f test.yml pause web3                                            // unpauses the <mark class="mark">web3</mark> service in the <mark class="mark">test.yml</mark> project     // -! <mark>docker-compose start</mark> won't start paused projects/services
    
    
// stop / start / restart -------------------------------------------------------------
    $ docker-compose stop                                                              // stops all services in the default project (does not remove stopped containers)    
    $ docker-compose ps
      Name                 Command                State     Ports
      -------------------------------------------------------------
      testcont    docker-entrypoint.sh /bin/ ...   Exit 137        
      testcont2   docker-entrypoint.sh /bin/ ...   Exit 137        
    
    
    $ docker-compose restart                                                           // restarts all services in the default project           // -! after this command changes in the <mark class="mark">docker-compose.yml</mark> file won't take effect    
    
    
    $ docker-compose -f test.yml start web3                                            // starts the <mark class="mark">web3</mark> service in the <mark class="mark">test.yml</mark> project    
    $ docker-compose ps 
      Name                 Command               State   Ports
      ----------------------------------------------------------
      testcont3    docker-entrypoint.sh /bin/ ...   Up           
    </pre>
    </details>
    <!---------------------------------------------------------------------------------------------------->
    <hr>
    <h2 style="color:darkblue; text-decoration: underline;"> Extending Service Configurations </h2>
    <p> - we can pass multiple <mark class="mark">*.yml</mark> files to up a system, in this case docker-compose merges <u>service configurations together</u>, if there's a conflict the <u>rightmost <mark class="mark">*.yml</mark> file</u> takes precedence on the service config </p>
    <pre class="syntax">
    $ docker-compose -f test.yml -f test2.yml up -d                                    // <mark class="mark">test2.yml</mark> will override the <mark class="mark">web1</mark> service <mark>network_mode</mark> config 
    </pre>
    <pre>
// test.yml (file) --------------------------------------------------------------------
    version: "3.3"
    services:
      web1:
        container_name: testcont
        image: testimg
        network_mode: "bridge" 
    
// test2.yml (file) -------------------------------------------------------------------
    version: "3.3"
    services:
      web1:
        network_mode: "host"                                                           // the web1 service will start in host network mode   
    </pre>
    <p> - by default a <mark class="mark">docker-compose.override.yml</mark> file (if present) is automatically merged (as rightmost <mark class="mark">*.yml</mark> file) <u>when the default <mark class="mark">docker-compose.yml</mark> docker-compose file used</u> </p>
    <pre class="syntax">
    $ docker-compose up -d                                                             // the same will happen as above but this is the default behaviour (when no <mark class="mark">*.yml</mark> file passed) 
    </pre>
    <pre>
// docker-compose.yml (file) ----------------------------------------------------------
    version: "3.3"
    services:
      web1:
        container_name: testcont
        image: testimg
        network_mode: "bridge" 
    
// docker-compose.override.yml (file) -------------------------------------------------
    version: "3.3"
    services:
      web1:
        network_mode: "host"                                                           // the web1 service will start in host network mode   
    </pre>
    <!---------------------------------------------------------------------------------------------------->
    <hr>
    <h2 style="color:darkblue; text-decoration: underline;"> Environment Variables </h2>
    <p> - we can use environment variables in docker-compose files, (just like in bash), environment variables are used from the shell where we start the docker-compose </p>
    <p> - we can define default environment variables in the <mark class="mark">.env</mark> file in the project folder, these are used as default when the shell does not provide the specified environment variable</p>
    <pre class="syntax">
    $ docker-compose up -d                                                             // will start the <mark class="mark">web1</mark> service from the <mark class="mark">default</mark> images (falls back to the default variable)
    
<span style="color:darkgray;">// ------------------------------------------------------------------------------------</span>
    WEB_SERVER1=testserver:latest
    $ docker-compose up -d                                                             // will start the <mark class="mark">web1</mark> service from the <mark class="mark">testserver</mark> images (uses the shell provided variable)    
    </pre>
    <pre>
// docker-compose.yml (file) ----------------------------------------------------------
    version: "3.3"
    services:
      web1:
        container_name: testcont
        image: ${WEB_SERVER1}                                                          // environment variable used here   
        network_mode: "host"
    
// .env (file) ------------------------------------------------------------------------
    WEB_SERVER1=default:latest                                                         // provides the default value of the <mark class="mark">WEB_SERVER1</mark> variable 
    </pre>
    <!---------------------------------------------------------------------------------------------------->
    <hr>
    <h2 class="header"> Profiles </h2>
    <p> - we can assign profiles to services, this way we can enable|disable them </p>
    <p> - services that have profiles needs to be enabled explicitly, services having no profile are enabled by default </p>
    <pre class="syntax">
    $ docker-compose up -d                                                             // starts <mark class="mark">web1</mark> service only   
    
<span style="color:darkgray;">// ------------------------------------------------------------------------------------</span>
    $ docker-compose --profile web2 up -d                                              // starts <mark class="mark">web1</mark> and <mark class="mark">web2</mark> services 
    </pre>
    <pre>
// docker-compose.yml (file) ----------------------------------------------------------
    version: "3.3"
    services:
      web1:                                                                            // service has no profile set so it is enabled by default 
        container_name: testcont
        build: .
        network_mode: "host"
      web2:                                                                            // service has profile so it has to be enabled explicitly 
        container_name: testcont2
        build:
          context: .
          dockerfile: Dockerfile2
        network_mode: "host"
        profiles: ['web2']                                                             // the asigned profile    
    </pre>
    <!---------------------------------------------------------------------------------------------------->
    <hr>
    <h2 class="headerExtra"> Compose File <a href="https://docs.docker.com/reference/compose-file/" target="_blank">[reference]</a> </h2>
    <p> - the Docker-Compose file (by default <mark class="mark">docker-compose.yml</mark>) is where we define our app structure </p>
    <p> - when starting the system Docker-Compose reads instructions from here then executes them, same goes when stopping the the app system, Docker-Compose reads instruction form this file to stop the services </p>
    <p> - there are different compose file versions, the version defines the syntax in the file and has to be declared at the top fo the file </p>
    <pre>
    version: "3.3"                                                                     // compose file version 
    services:
      web1:
        container_name: testcont
        build: .
        network_mode: "host"
    </pre>

    <br><br>
  </body>

</html>
