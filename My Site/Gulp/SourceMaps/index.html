<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title> Creating Sourcemaps with Gulp </title> 
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous"> 
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" href="../../Assets/stylesPages.css"> 
    <script src="../../Assets/scriptPages.js"></script>
</head>
<body>
<h1> Creating Sourcemaps with Gulp (ver 3.2) </h1>
    <p> Updated ( 2020-01-10 )</p>
    <p class="sitenav"> <a href="../../index.html" >MySite></a>
        <a href="../index.html">Gulp></a> SourceMaps 
    </p>
<h2 class="headerSection"> Notes : </h2>
    <details class="example" id="notes">
    <summary> Notes :</summary>
	<!-- <p> - paragraph removes the 'empty' message from the detail TAG -->
    </details>
<h2 class="headerSection"> Useful Links : </h2>

<h2 class="headerSection"> Remember This : </h2>
    <p> - Node.js (13.2.0) does not support sourcemapping by default, the <mark>source-map-support</mark> package must be installed and the <mark>require('source-map-support').install();</mark> required in the sourcecode [TESTED: 2020-01-11] </p>
<h2 class="headerSection"> Description and Demonstration : </h2>
    <img src="sourcemaps.jpg" alt="sourcemap" height="300" width="1000">
    <p> - When the Host reads a transpiled or compiled file but sees the original file (before transpiling) is called sourcemapping ('mapping the original source') </p>
    <p> - the sourcemap code is generated by the compiler (Gulp) and placed eigther at the bottom of the compiled file or in a new file which is linked from the bottom of the compiled file </p>
    <p> - the Host must have sourcemap support, (recognizes the <mark>//# sourceMappingURL=</mark> code at the bottom of the file) (Chrome, Mozilla, Opera has support [TESTED: 2020-01-13]) </p>
    <p style="color:yellow;"> - Node.js (13.2.0) does not support sourcemapping by default, the <mark>source-map-support</mark> package must be installed and the <mark>require('source-map-support').install();</mark> required in the sourcecode [TESTED: 2020-01-11] </p>
<h2 style="color:darkblue;"><u> Gulp creates sourcemaps </u></h2>
    <pre class="syntax">
SYNTAX :    &lt; gulpfile.js &gt;                                                            // this is how Gulp creates sourcemaps 
            
            src(<strong>glob|[glob, ...]</strong>, {sourcemaps:true})                                   // enabling sourcemapping   
            .pipe(<strong>gulp-plugin</strong>)                                                         // compiler or transpiler plugin   
            .pipe(dest(<strong>dir:glob|fn</strong>, {sourcemaps:true|<strong>dir:glob</strong>}))                       // <mark>true</mark> = creates the sourcemap code at the bottom of the compiled or transpiled file 
                                                                                          <strong>dir:glob</strong> = creates a new sourcemap file which linked from the bottom of the transpiled file (the sourcemap file is placed relative to the compiled file's path)    
    </pre>
    <pre>
    const {src, dest} = require('gulp');
    const minify = require('gulp-minify');                                             // minify gulp plugin  
    
    function compile(cb){
// inline sourcemap -------------------------------------------------------------------
        src('testScript.js', {sourcemaps:true})                                        // enables sourcemapping    
        .pipe(minify())
        .pipe(dest('testDir1', {sourcemaps:true}));                                    // places the sourcemap code directly at the bottom of the minified file   
            
// external file sourcemap ------------------------------------------------------------
        src('testScript.js', {sourcemaps:true})                                        // enables sourcemapping    
        .pipe(minify())
        .pipe(dest('testDir2', {sourcemaps:'srcMaps'}));                               // the sourcemap code is created in a new file in the './testDir2/srcMaps' sourcemap file directory referenced from the minified file's directory    
        
        cb();
    }
    
    exports.compile = compile;    
    </pre>
<h2 style="color:darkblue;"><u> SourceMap code </u></h2>
    <pre class="syntax">
SYNTAX :    &lt; compiled ot transpiled file &gt;
    <span style="color:darkgray;">// file content ... </span>
    
    //# sourceMappingURL=<strong>inline sourcemap code | path to external sourcemap file</strong>       // (at the bottom of the file) sourcemap code or path to a sourcemap file    
                                                                                          the Host (Browser or Server) maps the original file by this generated sourcemap code    
    </pre>
    <pre>
// original file 'testScript.js' ------------------------------------------------------
    require('source-map-support').install();                                           // this is for node only (this is how Node.js supports sourcemapping)    
    
    var testFunc = function(){
        console.log( "Hello World" );
        refErr;                                                                        // -! the Host (Node.js) throws an error on line 5 when runs the minified file through the sourcemap    
    }
    
    testFunc();    
    
// minified file with inline sourcemap code 'testScript-min.js' ----------------------- 
    require("source-map-support").install();var testFunc=function(){console.log("Hello World"),refErr};testFunc();
    //# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3RTY3JpcHQuanMiXSwibmFtZXMiOlsicmVxdWlyZSIsImluc3RhbGwiLCJ0ZXN0RnVuYyIsImNvbnNvbGUiLCJsb2ciLCJyZWZFcnIiXSwibWFwcGluZ3MiOiJBQUFBQSxRQUFRLHNCQUFzQkMsVUFFOUIsSUFBSUMsU0FBVyxXQUNYQyxRQUFRQyxJQUFLLGVBQ2JDLFFBR0pIIiwic291cmNlc0NvbnRlbnQiOlsicmVxdWlyZSgnc291cmNlLW1hcC1zdXBwb3J0JykuaW5zdGFsbCgpOyAgICAgICAgICAgICAgICAgICAgLy8gZm9yIG5vZGUgb25seSBcclxuXHJcbnZhciB0ZXN0RnVuYyA9IGZ1bmN0aW9uKCl7XHJcbiAgICBjb25zb2xlLmxvZyggXCJIZWxsbyBXb3JsZFwiICk7XHJcbiAgICByZWZFcnI7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJlZmVyZW5jZUVycm9yIFxyXG59XHJcblxyXG50ZXN0RnVuYygpOyJdfQ==    
                                                                                       // the Host (Node.js) recognizes the code after the '//# sourceMappingURL=' as sourcemap 
    
// minified file with linked sourcemap 'testScript-min.js' ----------------------------
    require("source-map-support").install();var testFunc=function(){console.log("Hello World"),refErr};testFunc();
    //# sourceMappingURL=srcMaps/testScript-min.js.map                                 // the Host (Node.js) recognizes the linked file as sourcemap   
    
// sourcemap file linked 'srcMaps/testScript.js.map' ----------------------------------
    {"version":3,"names":[],"mappings":"","sources":["testScript.js"],"sourcesContent":["require('source-map-support').install();                    / for node only \r\n\r\nvar testFunc = function(){\r\n    console.log( \"Hello World\" );\r\n    refErr;                                     / ReferenceError \r\n}\r\n\r\ntestFunc();"],"file":"testScript.js"}    
                                                                                       // sourcemap code    
    </pre>
<details class="example">
<summary> Example : </summary>
<h4 style="color:darkblue;"><u> SourceMapping Node.js TEST  </u></h4>
    <p style="color:yellow;"> - Node.js does not support source mapping by default, the "source-map-support" module installed in order to support source map </p>
    <pre style="margin-bottom:1px;">
// !! testJs.js (file) -------------------------------------------------------------------------------------
    require('source-map-support').install();                                           // sourcemap module must be required in order to support sourcemapping in Node.js   
        
    var helloWorld = function(){
        console.log( 'Hello World!');
        refErr;                                                                        // -! Reference error (on line 5)
    }
        
    helloWorld();    
      
        
// !! gulpfile.js (file) -----------------------------------------------------------------------------------
    const {src, dest, parallel} = require('gulp');
    const minify = require('gulp-minify');
    
// no source map created -------------------------------------------------------------
    function noSrcMap(cb){                                          
        src('testJs.js')                                       
        .pipe(minify())
        .pipe(dest('testDir'))
        cb();
    }
    
// local sourcemap (sourcemap code included in the compiled file) ---------------------
    function locSrcMap(cb){
        src('testJs.js', {sourcemaps:true})                                            // both sourcemaps options must be enabled 
        .pipe(minify())                                 
        .pipe(dest('testDir2', {sourcemaps:true}))                                     // both sourcemaps options must be enabled (local)
        cb();
    }
    
// external sourcemap (external sourcemap file created) -------------------------------
    function extSrcMap(cb){
        src('testJs.js', {sourcemaps:true})                                            // enable sourcemap
        .pipe(minify())
        .pipe(dest('testDir3', {sourcemaps:'./'}))                                     // sourcemap file created where the dest() method creates the destination file
        cb();
    }
    
    exports.default = parallel(noSrcMap, locSrcMap, extSrcMap);
    </pre>
    <pre class="cmd" style="margin-top:1px;">
// run task runner (Gulp) ---------------------------------------------------------------------
    PS D:\safe\code +\my site\03 improuve\learn webdesign\03.7 gulp\sourcemaps\01 sourcemapping Node.js TEST> gulp
        [20:15:02] Using gulpfile D:\safe\code +\my site\03 improuve\learn webdesign\03.7 gulp\sourcemaps\01 sourcemapping Node.js TEST\gulpfile.js
        [20:15:02] Starting 'default'...
        [20:15:02] Starting 'noSrcMap'...
        [20:15:02] Starting 'locSrcMap'...
        [20:15:02] Starting 'extSrcMap'...
        [20:15:02] Finished 'noSrcMap' after 14 ms
        [20:15:02] Finished 'locSrcMap' after 17 ms
        [20:15:02] Finished 'extSrcMap' after 18 ms
        [20:15:02] Finished 'default' after 22 ms
// run the minified file (withouth sourcemap) in 'testDir' directory --------------------------
    PS D:\safe\code +\my site\03 improuve\learn webdesign\03.7 gulp\sourcemaps\01 sourcemapping Node.js TEST> cd testDir
    PS D:\safe\code +\my site\03 improuve\learn webdesign\03.7 gulp\sourcemaps\01 sourcemapping Node.js TEST\testDir> node testJs-min.js
        Hello World!
        D:\safe\code +\my site\03 improuve\learn webdesign\03.7 gulp\sourcemaps\01 sourcemapping Node.js TEST\testDir\testJs-min.js:1       // -! error is thrown on line1 (in the copiled file)
        require("source-map-support").install();var helloWorld=function(){console.log("Hello World!"),refErr};helloWorld();                 // errored line
                                                                                                      ^
        ReferenceError: refErr is not defined
        at helloWorld (D:\safe\code +\my site\03 improuve\learn webdesign\03.7 gulp\sourcemaps\01 sourcemapping Node.js TEST\testDir\testJs-min.js:1:95)
        ...  
// run the minified file (with inline sourcemap) in 'testDir2' directory ----------------------
    PS D:\safe\code +\my site\03 improuve\learn webdesign\03.7 gulp\sourcemaps\01 sourcemapping Node.js TEST\testDir> cd..
    PS D:\safe\code +\my site\03 improuve\learn webdesign\03.7 gulp\sourcemaps\01 sourcemapping Node.js TEST> cd testDir2
    PS D:\safe\code +\my site\03 improuve\learn webdesign\03.7 gulp\sourcemaps\01 sourcemapping Node.js TEST\testDir2> node testJs-min.js
        Hello World!
        D:\safe\code +\my site\03 improuve\learn webdesign\03.7 gulp\sourcemaps\01 sourcemapping Node.js TEST\testDir2\testJs.js:5          // -! error is thrown on line 5 (original file)
        refErr;                                     // &lt;- Reference error (on line 5)                                                       // errored line 
        ^
        ReferenceError: refErr is not defined
        ...
// run the minified file (with external sourcemap file) in 'testDir3' directory ---------------
    PS D:\safe\code +\my site\03 improuve\learn webdesign\03.7 gulp\sourcemaps\01 sourcemapping Node.js TEST\testDir2> cd..
    PS D:\safe\code +\my site\03 improuve\learn webdesign\03.7 gulp\sourcemaps\01 sourcemapping Node.js TEST> cd testDir3
    PS D:\safe\code +\my site\03 improuve\learn webdesign\03.7 gulp\sourcemaps\01 sourcemapping Node.js TEST\testDir3> node testJs-min.js
    Hello World!
        D:\safe\code +\my site\03 improuve\learn webdesign\03.7 gulp\sourcemaps\01 sourcemapping Node.js TEST\testDir3\testJs.js:5          // -! error is thrown on line 5 (original file)
        refErr;                                     // &lt;- Reference error (on line 5)                                                       // errored line 
        ^
        ...
    PS D:\safe\code +\my site\03 improuve\learn webdesign\03.7 gulp\sourcemaps\01 sourcemapping Node.js TEST\testDir3>    
    </pre>
<!----------------------------------------------------------------------------------------------------------->
<hr>
<h4 style="color:darkblue;"><u> SourceMapping in Browser (tested in Chrome 79)  </u></h4>
    <p> - open console window to see the result </p>
    <script src="02 sourcemapping in Browser TEST/testDir1/testJS-min.js"></script>
    <script src="02 sourcemapping in Browser TEST/testDir2/testJS-min.js"></script>
    <script src="02 sourcemapping in Browser TEST/testDir3/testJS-min.js"></script>
    <pre>
// the browser only sees the minified file 'testJS-min.js' ---------------------------
    &lt;script src="02 sourcemapping in Browser TEST/testDir1/testJS-min.js"&gt;&lt;/script&gt;   // throws an error on line 1 because the minified JavaScript file is not sourcemapped    
    
// the browser sees the original file because these minified files are sourcemapped --
    &lt;script src="02 sourcemapping in Browser TEST/testDir2/testJS-min.js"&gt;&lt;/script&gt;   // throws an error on line 3 because the minified JavaScript file is sourcemapped to the original 
    &lt;script src="02 sourcemapping in Browser TEST/testDir3/testJS-min.js"&gt;&lt;/script&gt;   // throws an error on line 3 because the minified JavaScript file is sourcemapped to the original 
    
// -! files --------------------------------------------------------------------------
// (file) D:\safe\code +\my site\03 improuve\learn webdesign\03.7 gulp\sourcemaps\02 sourcemapping in Browser TEST\testJS.js 
    var helloWorld = function(){                                                      // -! this is the original file (this file is minified in 3 ways see below)   
        console.log( 'Hello World!');
        refErr;                                     // &lt;- Refference Error (on line 3)
    }
    helloWorld();
    
// -----------------------------------------------------------------------------------
// (file) D:\safe\code +\my site\03 improuve\learn webdesign\03.7 gulp\sourcemaps\02 sourcemapping in Browser TEST\testDir1\testJS-min.js  
    var helloWorld=function(){console.log("Hello World!"),refErr};helloWorld();       // minified script (without sourcemap)
    
// -----------------------------------------------------------------------------------
// (file) D:\safe\code +\my site\03 improuve\learn webdesign\03.7 gulp\sourcemaps\02 sourcemapping in Browser TEST\testDir2\testJS-min.js
    var helloWorld=function(){console.log("Hello World!"),refErr};helloWorld();       // minified script (with inline sourcemap)
    //# sourceMappingURL=data:application/json;charset=utf-8;base64,                  // inline sourcemap code  
    eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3RKUy5qcyJdLCJuYW1lcyI6WyJoZWxsb1dvcmxkIiwiY29uc29sZSIsImxvZyIsInJlZkVyciJdLCJtYXBwaW5ncyI6IkFBQUEs
    SUFBSUEsV0FBYSxXQUNiQyxRQUFRQyxJQUFLLGdCQUNiQyxRQUVKSCIsInNvdXJjZXNDb250ZW50IjpbInZhciBoZWxsb1dvcmxkID0gZnVuY3Rpb24oKXtcclxuICAgIGNvbnNv
    bGUubG9nKCAnSGVsbG8gV29ybGQhJyk7XHJcbiAgICByZWZFcnI7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIDwtIFJlZmZlcmVuY2UgRXJyb3IgKG9u
    IGxpbmUgMylcclxufVxyXG5oZWxsb1dvcmxkKCk7XHJcbiJdfQ==    
    
// -----------------------------------------------------------------------------------
// (file) D:\safe\code +\my site\03 improuve\learn webdesign\03.7 gulp\sourcemaps\02 sourcemapping in Browser TEST\testDir3\testJS-min.js   
    var helloWorld=function(){console.log("Hello World!"),refErr};helloWorld();
    //# sourceMappingURL=testJS-min.js.map                                            // references the sourcemap file 
    
// -----------------------------------------------------------------------------------
// (file) D:\safe\code +\my site\03 improuve\learn webdesign\03.7 gulp\sourcemaps\02 sourcemapping in Browser TEST\testDir3\testJS-min.js.map
    {"version":3,"sources":["testJS.js"],"names":["helloWorld","console","log","refErr"],"mappings":"AAAA,IAAIA,WAAa,WACbC,QAAQC,IAAK,gBACbC,QAEJH",
    "sourcesContent":["var helloWorld = function(){\r\n    console.log( 'Hello World!');\r\n    refErr;                                     // &lt;- 
    Refference Error (on line 3)\r\n}\r\nhelloWorld();\r\n"]}    
    </pre>
</details>
    
    <br><br>
</body>
</html>